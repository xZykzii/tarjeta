<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control de cuotas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #000000;
      color: #e5e7eb;
      margin: 0;
      padding: 16px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 12px;
      text-align: center;
    }
    .card {
      max-width: 1100px;
      margin: 0 auto;
      background: #000000;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.8);
      border: 1px solid #27272a;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .top-bar-left,
    .top-bar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px,1fr));
      gap: 8px;
      margin-bottom: 12px;
    }
    label {
      font-size: 12px;
      color: #9ca3af;
      display: block;
      margin-bottom: 2px;
    }
    input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #22c55e55;
    }
    button {
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
      background: #22c55e;
      color: #0b1120;
      font-weight: 600;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.1s;
      white-space: nowrap;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(34,197,94,0.35);
      background: #16a34a;
    }
    button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .danger-btn {
      background: #ef4444;
      color: #fee2e2;
    }
    .danger-btn:hover {
      background: #dc2626;
      box-shadow: 0 8px 16px rgba(248,113,113,0.35);
    }
    .warning-btn {
      background: #facc15;
      color: #1a1a1a;
    }
    .warning-btn:hover {
      background: #eab308;
      box-shadow: 0 8px 16px rgba(250,204,21,0.35);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #27272a;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(even) td { background: #050505; }
    tbody tr:nth-child(odd)  td { background: #000000; }
    .right { text-align: right; }
    .actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .summary {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
      gap: 12px;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #1d4ed8;
      font-size: 11px;
    }
    .totals-card {
      border-radius: 10px;
      border: 1px solid #27272a;
      padding: 10px;
      background: #020617;
      font-size: 13px;
    }
    .totals-card h2 {
      margin: 0 0 6px;
      font-size: 14px;
    }
    .person-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }
    .inline-group {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    #lockScreen {
      display: none;
      text-align: center;
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #27272a;
      background: #020617;
    }
    #contenido {
      margin-top: 8px;
    }
    .hidden {
      display: none !important;
    }
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      margin-top: 4px;
    }
    .filter-bar input {
      max-width: 220px;
    }
    @media (max-width: 700px) {
      .summary {
        grid-template-columns: 1fr;
      }
      table {
        font-size: 12px;
      }
      th, td {
        padding: 4px 6px;
      }
      .actions {
        flex-direction: column;
      }
      .top-bar {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Control de cuotas 游눱</h1>

    <!-- Pantalla de bloqueo -->
    <div id="lockScreen">
      <p>App bloqueada. Ingresa la contrase침a para ver tus datos.</p>
      <button id="unlockBtn">Desbloquear</button>
    </div>

    <div id="contenido">
      <div class="top-bar">
        <div class="top-bar-left">
          <span>Tarjeta activa:</span>
          <select id="tarjetaActiva"></select>
          <button id="addTarjetaBtn">A침adir tarjeta</button>
          <button id="delTarjetaBtn" class="danger-btn">Eliminar tarjeta</button>
        </div>
        <div class="top-bar-right">
          <button id="lockBtn" class="warning-btn">Bloquear app</button>
          <button id="exportBtn">Exportar backup</button>
          <button id="importBtn">Importar backup</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>

      <div style="margin-bottom:8px;color:#9ca3af;font-size:12px;">
        Cada 칤tem nuevo se guarda en la tarjeta activa. Haz backup peri칩dicamente para no perder nada.
      </div>

      <div class="form-grid">
        <div>
          <label>Persona</label>
          <div class="inline-group">
            <select id="personaSelect"></select>
            <button id="addPersonaBtn">+ persona</button>
            <button id="delPersonaBtn" class="danger-btn">- persona</button>
          </div>
        </div>
        <div>
          <label>칈tem</label>
          <input id="item" placeholder="Ej: Producto X" />
        </div>
        <div>
          <label>Monto base (valor de la cuota)</label>
          <input id="monto" type="number" min="0" step="1" placeholder="Ej: 10000" />
        </div>
        <div>
          <label>Cuotas pagadas</label>
          <input id="cuotasPagadas" type="number" min="0" step="1" placeholder="Ej: 3" />
        </div>
        <div>
          <label>Cuotas totales</label>
          <input id="cuotasTotales" type="number" min="1" step="1" placeholder="Ej: 12" />
        </div>
        <div style="display:flex;align-items:flex-end;gap:6px;flex-wrap:wrap;">
          <button id="addBtn">Agregar 칤tem</button>
          <button id="clearBtn" class="danger-btn">Borrar todo</button>
        </div>
      </div>

      <div class="filter-bar">
        <label for="filtro" style="font-size:12px;color:#9ca3af;">Filtro r치pido:</label>
        <input id="filtro" placeholder="Persona, 칤tem o tarjeta..." />
      </div>

      <table>
        <thead>
          <tr>
            <th>Persona</th>
            <th>Tarjeta</th>
            <th>칈tem</th>
            <th class="right">Monto cuota</th>
            <th>Cuotas</th>
            <th class="right">Total contrato</th>
            <th class="right">Pagado</th>
            <th class="right">Pendiente</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-body"></tbody>
      </table>

      <div class="summary">
        <div class="totals-card">
          <h2>Resumen tarjeta activa</h2>
          <div class="person-row">
            <span>Total contrato:</span>
            <span>$<span id="res-total-contrato">0</span></span>
          </div>
          <div class="person-row">
            <span>Total pagado:</span>
            <span>$<span id="res-total-pagado">0</span></span>
          </div>
          <div class="person-row">
            <span>Total pendiente:</span>
            <span>$<span id="res-total-pendiente">0</span></span>
          </div>
          <div class="person-row">
            <span>Cuota mensual estimada:</span>
            <span>$<span id="res-cuota-mensual">0</span></span>
          </div>
          <small class="badge">Basado en una cuota por mes por 칤tem pendiente</small>
        </div>

        <div class="totals-card">
          <h2>Totales por persona (pendiente)</h2>
          <div id="totales-persona"></div>
        </div>

        <div class="totals-card">
          <h2>Totales por tarjeta (pendiente)</h2>
          <div id="totales-tarjeta"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- RESET INICIAL PARA BORRAR VERSIONES ANTERIORES ----------
    const RESET_MARKER = "cuotas_reset_done_v3";
    if (!localStorage.getItem(RESET_MARKER)) {
      localStorage.removeItem("cuotas_items_v6");
      localStorage.removeItem("cuotas_items_v7");
      localStorage.removeItem("cuotas_items_v8");
      localStorage.removeItem("cuotas_tarjetas_v1");
      localStorage.removeItem("cuotas_tarjetas_v2");
      localStorage.removeItem("cuotas_tarjetas_v3");
      localStorage.removeItem("cuotas_personas_v1");
      localStorage.removeItem("cuotas_personas_v2");
      localStorage.removeItem("cuotas_personas_v3");
      localStorage.removeItem("cuotas_tarjeta_activa_v2");
      localStorage.removeItem("cuotas_tarjeta_activa_v3");
      localStorage.removeItem("cuotas_tarjeta_activa");
      localStorage.removeItem("cuotas_password_v1");
      localStorage.removeItem("cuotas_locked_v1");
      localStorage.removeItem("cuotas_locked_v2");
      localStorage.setItem(RESET_MARKER, "1");
    }

    const STORAGE_ITEMS = "cuotas_items_v9";
    const STORAGE_TARJETAS = "cuotas_tarjetas_v4";
    const STORAGE_TARJETA_ACTIVA = "cuotas_tarjeta_activa_v4";
    const STORAGE_PERSONAS = "cuotas_personas_v4";
    const STORAGE_LOCKED = "cuotas_locked_v3";
    const STORAGE_PASS = "cuotas_password_v1";

    let items = [];
    let tarjetas = [];
    let personas = [];
    let tarjetaActiva = "";
    let personaSeleccionada = "";
    let locked = false;
    let PASSWORD = "";

    function formatCLP(num) {
      return num.toLocaleString("es-CL");
    }

    function calcularFactor(pagadas, totales) {
      const p = Number(pagadas) || 0;
      const t = Number(totales) || 0;
      if (t <= 0) return 0;
      const f = t - p;
      return f > 0 ? f : 0;
    }

    function guardarEnStorage() {
      localStorage.setItem(STORAGE_ITEMS, JSON.stringify(items));
      localStorage.setItem(STORAGE_TARJETAS, JSON.stringify(tarjetas));
      localStorage.setItem(STORAGE_TARJETA_ACTIVA, tarjetaActiva);
      localStorage.setItem(STORAGE_PERSONAS, JSON.stringify(personas));
      localStorage.setItem(STORAGE_LOCKED, locked ? "1" : "0");
      if (PASSWORD) {
        localStorage.setItem(STORAGE_PASS, PASSWORD);
      }
    }

    function configurarPasswordInicial() {
      alert("Primera vez que usas la app.\nElige una contrase침a num칠rica para borrar datos o desbloquear.");
      while (true) {
        const p1 = prompt("Elige una contrase침a num칠rica (m칤nimo 4 d칤gitos):");
        if (p1 === null) {
          alert("Necesitas definir una contrase침a para continuar.");
          continue;
        }
        const limpio = p1.trim();
        if (!/^[0-9]{4,}$/.test(limpio)) {
          alert("Debe ser solo n칰meros y m칤nimo 4 d칤gitos.");
          continue;
        }
        const p2 = prompt("Confirma la contrase침a (escribe lo mismo):");
        if (p2 === null) {
          alert("Confirmaci칩n cancelada, int칠ntalo otra vez.");
          continue;
        }
        if (limpio !== p2.trim()) {
          alert("Las contrase침as no coinciden. Vuelve a intentarlo.");
          continue;
        }
        PASSWORD = limpio;
        localStorage.setItem(STORAGE_PASS, PASSWORD);
        alert("Contrase침a guardada. 칔sala para borrar datos o desbloquear la app.");
        break;
      }
    }

    function cargarPassword() {
      const saved = localStorage.getItem(STORAGE_PASS);
      if (saved) {
        PASSWORD = saved;
      } else {
        configurarPasswordInicial();
      }
    }

    function solicitarPassword(motivo = "esta acci칩n") {
      if (!PASSWORD) {
        configurarPasswordInicial();
      }
      const ingreso = prompt("Ingresa la contrase침a para " + motivo + ":");
      if (ingreso !== PASSWORD) {
        alert("Contrase침a incorrecta.");
        return false;
      }
      return true;
    }

    function cargarDeStorage() {
      try {
        const dataItems = localStorage.getItem(STORAGE_ITEMS);
        if (dataItems) items = JSON.parse(dataItems) || [];
      } catch {
        items = [];
      }

      items.forEach(it => {
        if (it.pagadas === undefined) it.pagadas = 0;
        if (it.totales === undefined || it.totales <= 0) it.totales = 1;
        if (it.monto === undefined) it.monto = 0;
        it.factor = calcularFactor(it.pagadas, it.totales);
        it.total = it.monto * it.factor;
      });

      try {
        const dataTarjetas = localStorage.getItem(STORAGE_TARJETAS);
        if (dataTarjetas) tarjetas = JSON.parse(dataTarjetas) || [];
      } catch {
        tarjetas = [];
      }
      if (!Array.isArray(tarjetas) || tarjetas.length === 0) {
        tarjetas = ["Tarjeta 1", "Tarjeta 2"];
      }
      items.forEach(it => {
        if (it.tarjeta && !tarjetas.includes(it.tarjeta)) tarjetas.push(it.tarjeta);
      });

      try {
        const storedActiva = localStorage.getItem(STORAGE_TARJETA_ACTIVA);
        if (storedActiva && tarjetas.includes(storedActiva)) {
          tarjetaActiva = storedActiva;
        } else {
          tarjetaActiva = tarjetas[0];
        }
      } catch {
        tarjetaActiva = tarjetas[0];
      }

      try {
        const dataPersonas = localStorage.getItem(STORAGE_PERSONAS);
        if (dataPersonas) personas = JSON.parse(dataPersonas) || [];
      } catch {
        personas = [];
      }
      if (!Array.isArray(personas) || personas.length === 0) {
        personas = ["Persona 1", "Persona 2"];
      }
      items.forEach(it => {
        if (it.persona && !personas.includes(it.persona)) personas.push(it.persona);
      });
      personaSeleccionada = personas[0];

      const lockedVal = localStorage.getItem(STORAGE_LOCKED);
      locked = lockedVal === "1";
    }

    function renderTarjetasSelect() {
      const select = document.getElementById("tarjetaActiva");
      select.innerHTML = "";
      tarjetas.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        if (t === tarjetaActiva) opt.selected = true;
        select.appendChild(opt);
      });
    }

    function renderPersonasSelect() {
      const select = document.getElementById("personaSelect");
      select.innerHTML = "";
      personas.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      });
      if (personas.includes(personaSeleccionada)) {
        select.value = personaSeleccionada;
      } else {
        personaSeleccionada = personas[0];
        select.value = personaSeleccionada;
      }
    }

    function aplicarLockUI() {
      const lockScreen = document.getElementById("lockScreen");
      const contenido = document.getElementById("contenido");
      if (locked) {
        lockScreen.style.display = "block";
        contenido.classList.add("hidden");
      } else {
        lockScreen.style.display = "none";
        contenido.classList.remove("hidden");
      }
    }

    function getFilteredItems() {
      const filtro = document.getElementById("filtro").value.toLowerCase().trim();
      let activos = items.filter(it => it.tarjeta === tarjetaActiva);
      if (filtro) {
        activos = activos.filter(it => {
          const txt = (it.persona + " " + it.item + " " + it.tarjeta).toLowerCase();
          return txt.includes(filtro);
        });
      }
      return activos;
    }

    function renderTabla() {
      const tbody = document.getElementById("tabla-body");
      tbody.innerHTML = "";

      const activos = getFilteredItems();

      let totalContratoTarjeta = 0;
      let totalPagadoTarjeta = 0;
      let totalPendienteTarjeta = 0;
      let cuotaMensual = 0;
      const porPersona = {};
      const porTarjeta = {};

      activos.forEach(it => {
        const idx = items.indexOf(it);
        const tr = document.createElement("tr");

        const totalContrato = it.monto * it.totales;
        const pagado = it.monto * it.pagadas;
        const pendiente = it.total;

        totalContratoTarjeta += totalContrato;
        totalPagadoTarjeta += pagado;
        totalPendienteTarjeta += pendiente;
        if (it.pagadas < it.totales) cuotaMensual += it.monto;
        porPersona[it.persona] = (porPersona[it.persona] || 0) + pendiente;

        const tdPersona = document.createElement("td");
        tdPersona.textContent = it.persona;
        tr.appendChild(tdPersona);

        const tdTarjeta = document.createElement("td");
        tdTarjeta.textContent = it.tarjeta || "-";
        tr.appendChild(tdTarjeta);

        const tdItem = document.createElement("td");
        tdItem.textContent = it.item;
        tr.appendChild(tdItem);

        const tdMonto = document.createElement("td");
        tdMonto.className = "right";
        tdMonto.textContent = "$" + formatCLP(it.monto);
        tr.appendChild(tdMonto);

        const tdCuotas = document.createElement("td");
        tdCuotas.textContent = `${it.pagadas}/${it.totales}`;
        tr.appendChild(tdCuotas);

        const tdTotalContrato = document.createElement("td");
        tdTotalContrato.className = "right";
        tdTotalContrato.textContent = "$" + formatCLP(totalContrato);
        tr.appendChild(tdTotalContrato);

        const tdPagado = document.createElement("td");
        tdPagado.className = "right";
        tdPagado.textContent = "$" + formatCLP(pagado);
        tr.appendChild(tdPagado);

        const tdPendiente = document.createElement("td");
        tdPendiente.className = "right";
        tdPendiente.textContent = "$" + formatCLP(pendiente);
        tr.appendChild(tdPendiente);

        const tdAcciones = document.createElement("td");
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "actions";

        const pagarBtn = document.createElement("button");
        pagarBtn.textContent = "Pagar cuota";
        pagarBtn.addEventListener("click", () => pagarCuota(idx));

        const deshacerBtn = document.createElement("button");
        deshacerBtn.textContent = "Deshacer cuota";
        deshacerBtn.className = "warning-btn";
        deshacerBtn.addEventListener("click", () => deshacerCuota(idx));

        const borrarBtn = document.createElement("button");
        borrarBtn.textContent = "Borrar";
        borrarBtn.className = "danger-btn";
        borrarBtn.addEventListener("click", () => borrarFila(idx));

        if (it.pagadas >= it.totales) {
          pagarBtn.disabled = true;
          pagarBtn.style.opacity = 0.5;
          pagarBtn.style.cursor = "default";
        }
        if (it.pagadas <= 0) {
          deshacerBtn.disabled = true;
          deshacerBtn.style.opacity = 0.5;
          deshacerBtn.style.cursor = "default";
        }

        actionsDiv.appendChild(pagarBtn);
        actionsDiv.appendChild(deshacerBtn);
        actionsDiv.appendChild(borrarBtn);
        tdAcciones.appendChild(actionsDiv);
        tr.appendChild(tdAcciones);

        tbody.appendChild(tr);
      });

      // Resumen tarjeta activa
      document.getElementById("res-total-contrato").textContent = formatCLP(totalContratoTarjeta);
      document.getElementById("res-total-pagado").textContent = formatCLP(totalPagadoTarjeta);
      document.getElementById("res-total-pendiente").textContent = formatCLP(totalPendienteTarjeta);
      document.getElementById("res-cuota-mensual").textContent = formatCLP(cuotaMensual);

      // Totales por persona
      const contPers = document.getElementById("totales-persona");
      contPers.innerHTML = "";
      const personasTot = Object.entries(porPersona);
      if (personasTot.length === 0) {
        contPers.textContent = "Sin datos todav칤a.";
      } else {
        personasTot.forEach(([persona, total]) => {
          const row = document.createElement("div");
          row.className = "person-row";
          row.innerHTML = `<span>${persona}</span><span>$${formatCLP(total)}</span>`;
          contPers.appendChild(row);
        });
      }

      // Totales por tarjeta (pendiente)
      const contTarjeta = document.getElementById("totales-tarjeta");
      contTarjeta.innerHTML = "";
      items.forEach(it => {
        const key = it.tarjeta || "Sin tarjeta";
        porTarjeta[key] = (porTarjeta[key] || 0) + it.total;
      });
      const tarjetasTotals = Object.entries(porTarjeta);
      if (tarjetasTotals.length === 0) {
        contTarjeta.textContent = "Sin datos todav칤a.";
      } else {
        tarjetasTotals.forEach(([tarj, total]) => {
          const row = document.createElement("div");
          row.className = "person-row";
          row.innerHTML = `<span>${tarj}</span><span>$${formatCLP(total)}</span>`;
          contTarjeta.appendChild(row);
        });
      }
    }

    function agregarItemDesdeFormulario() {
      const personaSel = document.getElementById("personaSelect");
      const itemInput = document.getElementById("item");
      const montoInput = document.getElementById("monto");
      const pagadasInput = document.getElementById("cuotasPagadas");
      const totalesInput = document.getElementById("cuotasTotales");

      const persona = personaSel.value || personas[0];
      const item = itemInput.value.trim() || "-";
      const monto = parseInt(montoInput.value, 10);
      const pagadas = parseInt(pagadasInput.value, 10) || 0;
      const totales = parseInt(totalesInput.value, 10) || 0;

      if (isNaN(monto) || monto <= 0) {
        alert("Pon un monto v치lido (mayor que 0).");
        return;
      }
      if (totales <= 0) {
        alert("Pon un n칰mero de cuotas totales mayor que 0.");
        return;
      }
      if (pagadas < 0 || pagadas > totales) {
        alert("Las cuotas pagadas deben estar entre 0 y el total.");
        return;
      }
      if (!tarjetaActiva) {
        alert("Primero crea o selecciona una tarjeta.");
        return;
      }

      const nuevo = {
        persona,
        tarjeta: tarjetaActiva,
        item,
        monto,
        pagadas,
        totales,
        factor: 0,
        total: 0
      };
      nuevo.factor = calcularFactor(nuevo.pagadas, nuevo.totales);
      nuevo.total = nuevo.monto * nuevo.factor;

      items.push(nuevo);
      guardarEnStorage();
      renderTabla();

      itemInput.value = "";
      montoInput.value = "";
      pagadasInput.value = "";
      totalesInput.value = "";
      itemInput.focus();
    }

    function pagarCuota(idx) {
      const it = items[idx];
      if (it.pagadas >= it.totales) return;
      it.pagadas += 1;
      it.factor = calcularFactor(it.pagadas, it.totales);
      it.total = it.monto * it.factor;
      guardarEnStorage();
      renderTabla();
    }

    function deshacerCuota(idx) {
      const it = items[idx];
      if (it.pagadas <= 0) return;
      it.pagadas -= 1;
      it.factor = calcularFactor(it.pagadas, it.totales);
      it.total = it.monto * it.factor;
      guardarEnStorage();
      renderTabla();
    }

    function borrarFila(idx) {
      if (!solicitarPassword("eliminar este 칤tem")) return;
      if (!confirm("쮹orrar este 칤tem?")) return;
      items.splice(idx, 1);
      guardarEnStorage();
      renderTabla();
    }

    function limpiarTodo() {
      if (!solicitarPassword("borrar todo")) return;
      if (!confirm("쯉eguro que quieres borrar TODOS los 칤tems? Esto no se puede deshacer.")) return;
      items = [];
      guardarEnStorage();
      renderTabla();
    }

    function a침adirTarjeta() {
      const nombre = prompt("Nombre de la nueva tarjeta (ej: Tarjeta 3):");
      if (!nombre) return;
      const n = nombre.trim();
      if (!n) return;
      if (tarjetas.includes(n)) {
        alert("Esa tarjeta ya existe.");
        return;
      }
      tarjetas.push(n);
      tarjetaActiva = n;
      guardarEnStorage();
      renderTarjetasSelect();
      renderTabla();
    }

    function eliminarTarjeta() {
      if (!tarjetaActiva) return;
      if (!solicitarPassword("eliminar esta tarjeta")) return;
      if (tarjetas.length <= 1) {
        alert("Debe quedar al menos una tarjeta.");
        return;
      }
      const asociados = items.filter(it => it.tarjeta === tarjetaActiva).length;
      const msg = `Se eliminar치 la tarjeta "${tarjetaActiva}" y ${asociados} 칤tems asociados.\n쯈uieres continuar?`;
      if (!confirm(msg)) return;

      items = items.filter(it => it.tarjeta !== tarjetaActiva);
      tarjetas = tarjetas.filter(t => t !== tarjetaActiva);
      if (tarjetas.length === 0) {
        tarjetas = ["Tarjeta 1"];
      }
      tarjetaActiva = tarjetas[0];
      guardarEnStorage();
      renderTarjetasSelect();
      renderTabla();
    }

    function a침adirPersona() {
      const nombre = prompt("Nombre de la nueva persona:");
      if (!nombre) return;
      const n = nombre.trim();
      if (!n) return;
      if (personas.includes(n)) {
        alert("Esa persona ya existe.");
        return;
      }
      personas.push(n);
      personaSeleccionada = n;
      guardarEnStorage();
      renderPersonasSelect();
    }

    function eliminarPersona() {
      if (!personaSeleccionada) return;
      if (!solicitarPassword("eliminar esta persona")) return;
      if (personas.length <= 1) {
        alert("Debe quedar al menos una persona en la lista.");
        return;
      }
      const msg = `Se eliminar치 la persona "${personaSeleccionada}" de la lista.\nLos 칤tems existentes seguir치n mostrando ese nombre.\n쯈uieres continuar?`;
      if (!confirm(msg)) return;

      personas = personas.filter(p => p !== personaSeleccionada);
      if (personas.length === 0) {
        personas = ["Persona 1"];
      }
      personaSeleccionada = personas[0];
      guardarEnStorage();
      renderPersonasSelect();
    }

    function exportarBackup() {
      const data = {
        version: 4,
        items,
        tarjetas,
        personas
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const hoy = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = "cuotas-backup-" + hoy + ".json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importarBackupDesdeArchivo(file) {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data || !Array.isArray(data.items) || !Array.isArray(data.tarjetas) || !Array.isArray(data.personas)) {
            alert("Archivo de backup inv치lido.");
            return;
          }
          if (!confirm("Esto reemplazar치 todas las tarjetas, personas e 칤tems actuales. 쮺ontinuar?")) {
            return;
          }

          items = data.items || [];
          tarjetas = data.tarjetas || [];
          personas = data.personas || [];

          items.forEach(it => {
            if (it.pagadas === undefined) it.pagadas = 0;
            if (it.totales === undefined || it.totales <= 0) it.totales = 1;
            if (it.monto === undefined) it.monto = 0;
            it.factor = calcularFactor(it.pagadas, it.totales);
            it.total = it.monto * it.factor;
          });

          if (!Array.isArray(tarjetas) || tarjetas.length === 0) {
            tarjetas = ["Tarjeta 1"];
          }
          if (!Array.isArray(personas) || personas.length === 0) {
            personas = ["Persona 1"];
          }

          tarjetaActiva = tarjetas[0];
          personaSeleccionada = personas[0];

          guardarEnStorage();
          renderTarjetasSelect();
          renderPersonasSelect();
          renderTabla();

          alert("Backup importado correctamente.");
        } catch (err) {
          console.error(err);
          alert("Error leyendo el archivo de backup.");
        }
      };
      reader.readAsText(file);
    }

    function bloquearApp() {
      locked = true;
      guardarEnStorage();
      aplicarLockUI();
    }

    function desbloquearApp() {
      if (!solicitarPassword("desbloquear la app")) return;
      locked = false;
      guardarEnStorage();
      aplicarLockUI();
    }

    // --------- EVENTOS ----------
    document.getElementById("addBtn").addEventListener("click", agregarItemDesdeFormulario);
    document.getElementById("clearBtn").addEventListener("click", limpiarTodo);
    document.getElementById("addTarjetaBtn").addEventListener("click", a침adirTarjeta);
    document.getElementById("delTarjetaBtn").addEventListener("click", eliminarTarjeta);
    document.getElementById("addPersonaBtn").addEventListener("click", a침adirPersona);
    document.getElementById("delPersonaBtn").addEventListener("click", eliminarPersona);
    document.getElementById("exportBtn").addEventListener("click", exportarBackup);
    document.getElementById("importBtn").addEventListener("click", () => {
      document.getElementById("importFile").value = "";
      document.getElementById("importFile").click();
    });
    document.getElementById("importFile").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) importarBackupDesdeArchivo(file);
    });
    document.getElementById("monto").addEventListener("keypress", e => {
      if (e.key === "Enter") agregarItemDesdeFormulario();
    });
    document.getElementById("cuotasTotales").addEventListener("keypress", e => {
      if (e.key === "Enter") agregarItemDesdeFormulario();
    });
    document.getElementById("tarjetaActiva").addEventListener("change", e => {
      tarjetaActiva = e.target.value;
      guardarEnStorage();
      renderTabla();
    });
    document.getElementById("personaSelect").addEventListener("change", e => {
      personaSeleccionada = e.target.value;
    });
    document.getElementById("lockBtn").addEventListener("click", bloquearApp);
    document.getElementById("unlockBtn").addEventListener("click", desbloquearApp);
    document.getElementById("filtro").addEventListener("input", renderTabla);

    // --------- INICIALIZAR ---------
    cargarDeStorage();
    cargarPassword();      // aqu칤 eliges la contrase침a la primera vez
    renderTarjetasSelect();
    renderPersonasSelect();
    aplicarLockUI();
    renderTabla();
  </script>
</body>
</html>
