<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control de cuotas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#000000" />

  <!-- Registro del Service Worker (para GitHub Pages en /tarjeta/) -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./sw.js")
          .catch(err => console.error("SW registration failed", err));
      });
    }
  </script>

  <style>
    :root {
      --bg-main: #020617;
      --bg-card: rgba(15,23,42,0.96);
      --border-subtle: #1f2937;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.12);
      --danger: #ef4444;
      --danger-soft: rgba(248,113,113,0.16);
      --warning: #facc15;
      --warning-soft: rgba(250,204,21,0.18);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #111827 0, #020617 45%, #000000 100%);
      color: var(--text-main);
      margin: 0;
      padding: 24px 16px;
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .card {
      width: 100%;
      max-width: 1150px;
      margin: 0 auto;
      background: var(--bg-card);
      border-radius: 18px;
      padding: 18px 18px 20px;
      box-shadow:
        0 24px 60px rgba(0,0,0,0.9),
        0 0 0 1px rgba(15,23,42,0.8);
      border: 1px solid var(--border-subtle);
      backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at top left, rgba(34,197,94,0.12), transparent 55%),
        radial-gradient(circle at bottom right, rgba(56,189,248,0.08), transparent 55%);
      opacity: 0.8;
      pointer-events: none;
      z-index: -1;
    }

    h1 {
      font-size: 26px;
      margin-bottom: 4px;
      text-align: center;
      letter-spacing: 0.04em;
      background: linear-gradient(120deg, #22c55e, #a855f7, #38bdf8);
      -webkit-background-clip: text;
      color: transparent;
    }

    .subtitle {
      text-align: center;
      margin: 0 0 14px;
      font-size: 13px;
      color: var(--text-soft);
    }

    /* LOGIN */
    #login-box {
      text-align: center;
      margin-bottom: 16px;
      padding: 12px 12px 14px;
      border-radius: 12px;
      border: 1px dashed #27272a;
      background: rgba(15,23,42,0.85);
    }

    #login-box p {
      margin-bottom: 8px;
      color: var(--text-main);
    }

    #login-info {
      font-size: 12px;
      color: var(--text-muted) !important;
      margin-top: 6px;
    }

    /* TOP BAR */
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: radial-gradient(circle at top left, rgba(31,41,55,0.9), rgba(15,23,42,0.96));
      border: 1px solid rgba(55,65,81,0.7);
    }

    .top-bar-left,
    .top-bar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .top-bar-left span {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* FORM */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
      gap: 10px;
      margin-bottom: 12px;
      margin-top: 4px;
    }

    label {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      margin-bottom: 3px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    input,
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: var(--text-main);
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, transform 0.05s ease;
    }

    input::placeholder {
      color: var(--text-soft);
      font-size: 12px;
    }

    select {
      padding-right: 26px;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
                        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 14px) 9px, calc(100% - 9px) 9px;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      appearance: none;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft), 0 0 0 1px rgba(15,23,42,0.9);
      background: #020617;
      transform: translateY(-0.5px);
    }

    .inline-group {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* BUTTONS */
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
      background: var(--accent);
      color: #0b1120;
      font-weight: 600;
      transition:
        transform 0.06s ease,
        box-shadow 0.08s ease,
        background 0.12s ease,
        filter 0.12s ease;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(34,197,94,0.35);
      background: #16a34a;
      filter: brightness(1.03);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
      filter: brightness(0.98);
    }

    .danger-btn {
      background: var(--danger);
      color: #fee2e2;
    }

    .danger-btn:hover {
      background: #dc2626;
      box-shadow: 0 10px 22px var(--danger-soft);
    }

    .warning-btn {
      background: var(--warning);
      color: #1a1a1a;
    }

    .warning-btn:hover {
      background: #eab308;
      box-shadow: 0 10px 22px var(--warning-soft);
    }

    button[disabled] {
      opacity: 0.4 !important;
      cursor: default !important;
      box-shadow: none !important;
      transform: none !important;
      filter: none !important;
    }

    /* FILTER BAR */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15,23,42,0.85);
      border: 1px solid #27272a;
    }

    .filter-bar input {
      max-width: 260px;
    }

    .filter-bar label {
      margin-bottom: 0;
    }

    /* TABLE */
    .table-wrapper {
      width: 100%;
      margin-top: 6px;
      border-radius: 12px;
      overflow-x: auto;              /* scroll horizontal en m칩vil */
      overflow-y: hidden;
      border: 1px solid #27272a;
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(0,0,0,0.98));
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 640px;
    }

    th, td {
      padding: 7px 9px;
      border-bottom: 1px solid #111827;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: linear-gradient(to right, #020617, #020617);
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    tbody tr:nth-child(even) td { background: #020617; }
    tbody tr:nth-child(odd)  td { background: #020617; }

    tbody tr:hover td {
      background: #030712;
    }

    .right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    /* SUMMARY */
    .summary {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px,1fr));
      gap: 12px;
    }

    .totals-card {
      border-radius: 12px;
      border: 1px solid #27272a;
      padding: 10px;
      background: radial-gradient(circle at top left, rgba(15,23,42,1), rgba(0,0,0,1));
      font-size: 13px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.6);
    }

    .totals-card h2 {
      margin: 0 0 6px;
      font-size: 14px;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .totals-card h2 small {
      font-size: 11px;
      color: var(--text-soft);
      font-weight: 400;
    }

    .person-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
      color: var(--text-main);
    }

    .person-row span:last-child {
      font-variant-numeric: tabular-nums;
    }

    .badge {
      display: inline-block;
      margin-top: 6px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(37,99,235,0.14);
      border: 1px solid rgba(59,130,246,0.5);
      font-size: 11px;
      color: #bfdbfe;
    }

    .hidden { display: none !important; }

    /* RESPONSIVE */
    @media (max-width: 900px) {
      body {
        padding-top: 18px;
      }

      .card {
        padding: 14px 12px 16px;
      }

      .table-wrapper {
        border-radius: 10px;
      }
    }

    @media (max-width: 700px) {
      .summary {
        grid-template-columns: 1fr;
      }
      table {
        font-size: 12px;
      }
      th, td {
        padding: 5px 7px;
      }
      .actions {
        flex-direction: column;
      }
      .top-bar {
        align-items: flex-start;
      }
      .filter-bar input {
        max-width: 100%;
      }
    }

    @media (max-width: 500px) {
      h1 {
        font-size: 22px;
      }
      .subtitle {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Control de cuotas 游눱</h1>
    <p class="subtitle">Organiza tus compras en cuotas por persona y tarjeta, con respaldo en la nube.</p>

    <!-- LOGIN CON FIREBASE GOOGLE -->
    <div id="login-box">
      <p id="login-texto">Inicia sesi칩n con Google para usar la app.</p>
      <button id="loginBtn">Iniciar sesi칩n con Google</button>
      <button id="logoutBtn" class="warning-btn hidden">Cerrar sesi칩n</button>
      <p id="login-info"></p>
    </div>

    <!-- CONTENIDO DE LA APP (se oculta hasta que haya login) -->
    <div id="contenido" class="hidden">
      <div class="top-bar">
        <div class="top-bar-left">
          <span>Tarjeta activa:</span>
          <select id="tarjetaActiva"></select>
          <button id="addTarjetaBtn">A침adir tarjeta</button>
          <button id="delTarjetaBtn" class="danger-btn">Eliminar tarjeta</button>
        </div>
        <div class="top-bar-right">
          <button id="exportBtn">Exportar backup</button>
          <button id="importBtn">Importar backup</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>

      <div style="margin-bottom:8px;color:#9ca3af;font-size:12px;">
        Cada 칤tem nuevo se guarda en la tarjeta activa. Tus datos se sincronizan en la nube (Firebase) por cuenta de Google.
      </div>

      <div class="form-grid">
        <div>
          <label>Persona</label>
          <div class="inline-group">
            <select id="personaSelect"></select>
            <button id="addPersonaBtn">+ persona</button>
            <button id="delPersonaBtn" class="danger-btn">- persona</button>
          </div>
          <div style="margin-top:6px;font-size:11px;color:#9ca3af;">
            Saldo actual: $<span id="saldo-actual-persona">0</span>
          </div>
          <div class="inline-group" style="margin-top:4px;">
            <input id="saldoMonto" type="number" min="0" step="1" placeholder="Agregar saldo a la persona" />
            <button id="addSaldoBtn">+ saldo</button>
          </div>
        </div>
        <div>
          <label>칈tem</label>
          <input id="item" placeholder="Ej: Playstation 5, notebook, etc." />
        </div>
        <div>
          <label>Monto base (valor de la cuota)</label>
          <input id="monto" type="number" min="0" step="1" placeholder="Ej: 10000" />
        </div>
        <div>
          <label>Cuotas pagadas</label>
          <input id="cuotasPagadas" type="number" min="0" step="1" placeholder="Ej: 3" />
        </div>
        <div>
          <label>Cuotas totales</label>
          <input id="cuotasTotales" type="number" min="1" step="1" placeholder="Ej: 12" />
        </div>
        <div style="display:flex;align-items:flex-end;gap:6px;flex-wrap:wrap;">
          <button id="addBtn">Agregar 칤tem</button>
          <button id="clearBtn" class="danger-btn">Borrar todo</button>
        </div>
      </div>

      <div class="filter-bar">
        <label for="filtro" style="font-size:12px;color:#9ca3af;">Filtro r치pido:</label>
        <input id="filtro" placeholder="Persona, 칤tem o tarjeta..." />
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Persona</th>
              <th>Tarjeta</th>
              <th>칈tem</th>
              <th class="right">Monto cuota</th>
              <th>Cuotas</th>
              <th class="right">Total contrato</th>
              <th class="right">Pagado</th>
              <th class="right">Pendiente</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-body"></tbody>
        </table>
      </div>

      <div class="summary">
        <div class="totals-card">
          <h2>Resumen tarjeta activa</h2>
          <div class="person-row">
            <span>Total contrato:</span>
            <span>$<span id="res-total-contrato">0</span></span>
          </div>
          <div class="person-row">
            <span>Total pagado:</span>
            <span>$<span id="res-total-pagado">0</span></span>
          </div>
          <div class="person-row">
            <span>Total pendiente:</span>
            <span>$<span id="res-total-pendiente">0</span></span>
          </div>
          <div class="person-row">
            <span>Cuota mensual estimada:</span>
            <span>$<span id="res-cuota-mensual">0</span></span>
          </div>
          <span class="badge">Basado en una cuota por mes por 칤tem pendiente</span>
        </div>

        <div class="totals-card">
          <h2>Pendiente por persona</h2>
          <div id="totales-persona"></div>
        </div>

        <div class="totals-card">
          <h2>Pendiente por tarjeta</h2>
          <div id="totales-tarjeta"></div>
        </div>

        <div class="totals-card">
          <h2>Cuota mensual por persona <small>(tarjeta activa)</small></h2>
          <div id="totales-mensual-persona"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS: Firebase + l칩gica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCG1b1R2NP12kqQ6hsvI80Ajv56biQoebc",
      authDomain: "tarjeta-cuotas.firebaseapp.com",
      projectId: "tarjeta-cuotas",
      storageBucket: "tarjeta-cuotas.firebasestorage.app",
      messagingSenderId: "469467519102",
      appId: "1:469467519102:web:d3032a02ff1a53a527602f",
      measurementId: "G-49RR054112"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    // Estado
    let items = [];
    let tarjetas = [];
    let personas = [];
    let tarjetaActiva = "";
    let personaSeleccionada = "";
    let currentUser = null; // user de Firebase
    let saldos = {}; // saldo por persona

    // Helpers UI
    const contenido   = document.getElementById("contenido");
    const loginTexto  = document.getElementById("login-texto");
    const loginInfo   = document.getElementById("login-info");
    const loginBtn    = document.getElementById("loginBtn");
    const logoutBtn   = document.getElementById("logoutBtn");
    const tablaBody   = document.getElementById("tabla-body");
    const filtroInput = document.getElementById("filtro");
    const saldoActualSpan = document.getElementById("saldo-actual-persona");

    function formatCLP(num) {
      return (Number(num) || 0).toLocaleString("es-CL");
    }

    function calcularFactor(pagadas, totales) {
      const p = Number(pagadas) || 0;
      const t = Number(totales) || 0;
      if (t <= 0) return 0;
      const f = t - p;
      return f > 0 ? f : 0;
    }

    function updateSaldoUI() {
      if (!personaSeleccionada) {
        saldoActualSpan.textContent = "0";
        return;
      }
      const saldo = saldos[personaSeleccionada] || 0;
      saldoActualSpan.textContent = formatCLP(saldo);
    }

    async function saveUserData() {
      if (!currentUser) return;
      const uid = currentUser.uid;

      const cleanedItems = items.map(it => ({
        persona: it.persona,
        tarjeta: it.tarjeta,
        item:    it.item,
        monto:   it.monto,
        pagadas: it.pagadas,
        totales: it.totales,
        completedAt: it.completedAt || null
      }));

      await setDoc(
        doc(db, "users", uid),
        {
          items: cleanedItems,
          tarjetas,
          personas,
          tarjetaActiva,
          saldos
        },
        { merge: true }
      );
    }

    async function loadUserData() {
      if (!currentUser) return;
      const uid = currentUser.uid;

      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        items        = data.items        || [];
        tarjetas     = data.tarjetas     || [];
        personas     = data.personas     || [];
        tarjetaActiva = data.tarjetaActiva || (tarjetas[0] || "");
        saldos       = data.saldos && typeof data.saldos === "object" ? data.saldos : {};
      } else {
        // Primer uso para este usuario
        items    = [];
        tarjetas = ["Tarjeta 1", "Tarjeta 2"];
        personas = ["Persona 1", "Persona 2"];
        tarjetaActiva = tarjetas[0];
        saldos = {};
        await saveUserData();
      }

      // Normalizar items
      items.forEach(it => {
        if (it.pagadas === undefined) it.pagadas = 0;
        if (it.totales === undefined || it.totales <= 0) it.totales = 1;
        if (it.monto === undefined) it.monto = 0;

        if (typeof it.completedAt !== "number") {
          it.completedAt = null;
        }

        it.factor = calcularFactor(it.pagadas, it.totales);
        it.total  = it.monto * it.factor;
      });

      // limpiar items completos hace m치s de 10 min
      cleanupCompletedItems();

      if (!Array.isArray(tarjetas) || tarjetas.length === 0) {
        tarjetas = ["Tarjeta 1", "Tarjeta 2"];
      }
      if (!tarjetaActiva || !tarjetas.includes(tarjetaActiva)) {
        tarjetaActiva = tarjetas[0];
      }
      if (!Array.isArray(personas) || personas.length === 0) {
        personas = ["Persona 1", "Persona 2"];
      }
      personaSeleccionada = personas[0];

      renderTarjetasSelect();
      renderPersonasSelect();
      renderTabla();
      updateSaldoUI();
    }

    // Borra 칤tems que llevan m치s de 10 minutos completos
    function cleanupCompletedItems() {
      const now = Date.now();
      let changed = false;

      items = items.filter(it => {
        if (it.pagadas >= it.totales && it.completedAt) {
          const diff = now - it.completedAt;
          if (diff > 10 * 60 * 1000) { // 10 minutos
            changed = true;
            return false; // lo eliminamos
          }
        }
        return true;
      });

      if (changed && currentUser) {
        saveUserData();
      }
    }

    function requireLogin() {
      if (!currentUser) {
        alert("Primero inicia sesi칩n con Google.");
        return false;
      }
      return true;
    }

    // Selects
    function renderTarjetasSelect() {
      const select = document.getElementById("tarjetaActiva");
      select.innerHTML = "";
      tarjetas.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        if (t === tarjetaActiva) opt.selected = true;
        select.appendChild(opt);
      });
    }

    function renderPersonasSelect() {
      const select = document.getElementById("personaSelect");
      select.innerHTML = "";
      personas.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      });
      if (personas.includes(personaSeleccionada)) {
        select.value = personaSeleccionada;
      } else {
        personaSeleccionada = personas[0];
        select.value = personaSeleccionada;
      }
      updateSaldoUI();
    }

    // Tabla + resumen
    function getFilteredItems() {
      const filtro = filtroInput.value.toLowerCase().trim();
      let activos = items.filter(it => it.tarjeta === tarjetaActiva);
      if (filtro) {
        activos = activos.filter(it => {
          const txt = (it.persona + " " + it.item + " " + it.tarjeta).toLowerCase();
          return txt.includes(filtro);
        });
      }
      return activos;
    }

    function renderTabla() {
      // limpiar en cada render por si ya pasaron los 10 min
      cleanupCompletedItems();

      tablaBody.innerHTML = "";
      const activos = getFilteredItems();

      let totalContratoTarjeta  = 0;
      let totalPagadoTarjeta    = 0;
      let totalPendienteTarjeta = 0;
      let cuotaMensualGlobal    = 0;

      const porPersonaPendiente = {};
      const porTarjetaPendiente = {};
      const mensualPorPersona   = {};

      activos.forEach(it => {
        const idx = items.indexOf(it);
        const tr  = document.createElement("tr");

        const totalContrato = it.monto * it.totales;
        const pagado        = it.monto * it.pagadas;
        const pendiente     = it.total;

        totalContratoTarjeta  += totalContrato;
        totalPagadoTarjeta    += pagado;
        totalPendienteTarjeta += pendiente;

        if (it.pagadas < it.totales) {
          cuotaMensualGlobal += it.monto;
          mensualPorPersona[it.persona] = (mensualPorPersona[it.persona] || 0) + it.monto;
        }

        porPersonaPendiente[it.persona] = (porPersonaPendiente[it.persona] || 0) + pendiente;

        const tdPersona = document.createElement("td");
        tdPersona.textContent = it.persona;
        tr.appendChild(tdPersona);

        const tdTarjeta = document.createElement("td");
        tdTarjeta.textContent = it.tarjeta || "-";
        tr.appendChild(tdTarjeta);

        const tdItem = document.createElement("td");
        tdItem.textContent = it.item;
        tr.appendChild(tdItem);

        const tdMonto = document.createElement("td");
        tdMonto.className = "right";
        tdMonto.textContent = "$" + formatCLP(it.monto);
        tr.appendChild(tdMonto);

        const tdCuotas = document.createElement("td");
        tdCuotas.textContent = `${it.pagadas}/${it.totales}`;
        tr.appendChild(tdCuotas);

        const tdTotalContrato = document.createElement("td");
        tdTotalContrato.className = "right";
        tdTotalContrato.textContent = "$" + formatCLP(totalContrato);
        tr.appendChild(tdTotalContrato);

        const tdPagado = document.createElement("td");
        tdPagado.className = "right";
        tdPagado.textContent = "$" + formatCLP(pagado);
        tr.appendChild(tdPagado);

        const tdPendiente = document.createElement("td");
        tdPendiente.className = "right";
        tdPendiente.textContent = "$" + formatCLP(pendiente);
        tr.appendChild(tdPendiente);

        const tdAcciones = document.createElement("td");
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "actions";

        const pagarBtn = document.createElement("button");
        pagarBtn.textContent = "Pagar cuota";
        pagarBtn.addEventListener("click", async () => {
          if (!requireLogin()) return;
          await pagarCuota(idx);
        });

        const deshacerBtn = document.createElement("button");
        deshacerBtn.textContent = "Deshacer cuota";
        deshacerBtn.className = "warning-btn";
        deshacerBtn.addEventListener("click", async () => {
          if (!requireLogin()) return;
          await deshacerCuota(idx);
        });

        const borrarBtn = document.createElement("button");
        borrarBtn.textContent = "Borrar";
        borrarBtn.className = "danger-btn";
        borrarBtn.addEventListener("click", async () => {
          if (!requireLogin()) return;
          await borrarFila(idx);
        });

        if (it.pagadas >= it.totales) {
          pagarBtn.disabled = true;
        }
        if (it.pagadas <= 0) {
          deshacerBtn.disabled = true;
        }

        actionsDiv.appendChild(pagarBtn);
        actionsDiv.appendChild(deshacerBtn);
        actionsDiv.appendChild(borrarBtn);
        tdAcciones.appendChild(actionsDiv);
        tr.appendChild(tdAcciones);

        tablaBody.appendChild(tr);
      });

      // Resumen tarjeta activa
      document.getElementById("res-total-contrato").textContent  = formatCLP(totalContratoTarjeta);
      document.getElementById("res-total-pagado").textContent    = formatCLP(totalPagadoTarjeta);
      document.getElementById("res-total-pendiente").textContent = formatCLP(totalPendienteTarjeta);
      document.getElementById("res-cuota-mensual").textContent   = formatCLP(cuotaMensualGlobal);

      // Pendiente por persona
      const contPers = document.getElementById("totales-persona");
      contPers.innerHTML = "";
      const personasTot = Object.entries(porPersonaPendiente);
      if (personasTot.length === 0) {
        contPers.textContent = "Sin datos todav칤a.";
      } else {
        personasTot.forEach(([persona, total]) => {
          const row = document.createElement("div");
          row.className = "person-row";
          row.innerHTML = `<span>${persona}</span><span>$${formatCLP(total)}</span>`;
          contPers.appendChild(row);
        });
      }

      // Pendiente por tarjeta
      const contTarjeta = document.getElementById("totales-tarjeta");
      contTarjeta.innerHTML = "";
      items.forEach(it => {
        const key = it.tarjeta || "Sin tarjeta";
        porTarjetaPendiente[key] = (porTarjetaPendiente[key] || 0) + it.total;
      });
      const tarjetasTotals = Object.entries(porTarjetaPendiente);
      if (tarjetasTotals.length === 0) {
        contTarjeta.textContent = "Sin datos todav칤a.";
      } else {
        tarjetasTotals.forEach(([tarj, total]) => {
          const row = document.createElement("div");
          row.className = "person-row";
          row.innerHTML = `<span>${tarj}</span><span>$${formatCLP(total)}</span>`;
          contTarjeta.appendChild(row);
        });
      }

      // Cuota mensual por persona (tarjeta activa)
      const contMensualPersona = document.getElementById("totales-mensual-persona");
      contMensualPersona.innerHTML = "";
      const mensualTot = Object.entries(mensualPorPersona);
      if (mensualTot.length === 0) {
        contMensualPersona.textContent = "Sin cuotas pendientes en esta tarjeta.";
      } else {
        mensualTot.forEach(([persona, total]) => {
          const row = document.createElement("div");
          row.className = "person-row";
          row.innerHTML = `<span>${persona}</span><span>$${formatCLP(total)}</span>`;
          contMensualPersona.appendChild(row);
        });
      }
    }

    // Acciones
    async function agregarItemDesdeFormulario() {
      if (!requireLogin()) return;

      const personaSel   = document.getElementById("personaSelect");
      const itemInput    = document.getElementById("item");
      const montoInput   = document.getElementById("monto");
      const pagadasInput = document.getElementById("cuotasPagadas");
      const totalesInput = document.getElementById("cuotasTotales");

      const persona = personaSel.value || personas[0];
      const item    = itemInput.value.trim() || "-";
      const monto   = parseInt(montoInput.value, 10);
      const pagadas = parseInt(pagadasInput.value, 10) || 0;
      const totales = parseInt(totalesInput.value, 10) || 0;

      if (isNaN(monto) || monto <= 0) {
        alert("Pon un monto v치lido (mayor que 0).");
        return;
      }
      if (totales <= 0) {
        alert("Pon un n칰mero de cuotas totales mayor que 0.");
        return;
      }
      if (pagadas < 0 || pagadas > totales) {
        alert("Las cuotas pagadas deben estar entre 0 y el total.");
        return;
      }
      if (!tarjetaActiva) {
        alert("Primero crea o selecciona una tarjeta.");
        return;
      }

      const nuevo = {
        persona,
        tarjeta: tarjetaActiva,
        item,
        monto,
        pagadas,
        totales,
        factor: 0,
        total: 0,
        completedAt: null
      };
      nuevo.factor = calcularFactor(nuevo.pagadas, nuevo.totales);
      nuevo.total  = nuevo.monto * nuevo.factor;

      items.push(nuevo);
      await saveUserData();
      renderTabla();

      itemInput.value    = "";
      montoInput.value   = "";
      pagadasInput.value = "";
      totalesInput.value = "";
      itemInput.focus();
    }

    async function agregarSaldoPersona() {
      if (!requireLogin()) return;
      const input = document.getElementById("saldoMonto");
      const valor = parseInt(input.value, 10);
      if (isNaN(valor) || valor <= 0) {
        alert("Ingresa un monto de saldo v치lido (mayor que 0).");
        return;
      }
      const actual = saldos[personaSeleccionada] || 0;
      saldos[personaSeleccionada] = actual + valor;
      input.value = "";
      await saveUserData();
      updateSaldoUI();
    }

    async function pagarCuota(idx) {
      const it = items[idx];
      if (!it) return;
      if (it.pagadas >= it.totales) return;

      const persona = it.persona;
      const montoCuota = it.monto;
      const saldoDisp = saldos[persona] || 0;

      if (saldoDisp < montoCuota) {
        alert(
          `Saldo insuficiente para pagar esta cuota.\n` +
          `Saldo disponible para ${persona}: $${formatCLP(saldoDisp)}\n` +
          `Monto de la cuota: $${formatCLP(montoCuota)}`
        );
        return;
      }

      // descontar del saldo de la persona
      saldos[persona] = saldoDisp - montoCuota;

      it.pagadas += 1;
      it.factor   = calcularFactor(it.pagadas, it.totales);
      it.total    = it.monto * it.factor;

      if (it.pagadas >= it.totales) {
        it.completedAt = Date.now();
      } else {
        it.completedAt = null;
      }

      await saveUserData();
      updateSaldoUI();
      renderTabla();
    }

    async function deshacerCuota(idx) {
      const it = items[idx];
      if (!it) return;
      if (it.pagadas <= 0) return;

      it.pagadas -= 1;
      it.factor   = calcularFactor(it.pagadas, it.totales);
      it.total    = it.monto * it.factor;

      if (it.pagadas < it.totales) {
        it.completedAt = null;
      }

      // OJO: al deshacer NO devolvemos saldo autom치tico, se asume que fue pago real

      await saveUserData();
      renderTabla();
    }

    async function borrarFila(idx) {
      if (!confirm("쮹orrar este 칤tem?")) return;
      items.splice(idx, 1);
      await saveUserData();
      renderTabla();
    }

    async function limpiarTodo() {
      if (!requireLogin()) return;
      if (!confirm("쯉eguro que quieres borrar TODOS los 칤tems de esta cuenta?")) return;
      items = [];
      await saveUserData();
      renderTabla();
    }

    async function a침adirTarjeta() {
      if (!requireLogin()) return;
      const nombre = prompt("Nombre de la nueva tarjeta (ej: Tarjeta 3):");
      if (!nombre) return;
      const n = nombre.trim();
      if (!n) return;
      if (tarjetas.includes(n)) {
        alert("Esa tarjeta ya existe.");
        return;
      }
      tarjetas.push(n);
      tarjetaActiva = n;
      await saveUserData();
      renderTarjetasSelect();
      renderTabla();
    }

    async function eliminarTarjeta() {
      if (!requireLogin()) return;
      if (!tarjetaActiva) return;
      if (tarjetas.length <= 1) {
        alert("Debe quedar al menos una tarjeta.");
        return;
      }
      const asociados = items.filter(it => it.tarjeta === tarjetaActiva).length;
      const msg = `Se eliminar치 la tarjeta "${tarjetaActiva}" y ${asociados} 칤tems asociados.\n쯈uieres continuar?`;
      if (!confirm(msg)) return;

      items    = items.filter(it => it.tarjeta !== tarjetaActiva);
      tarjetas = tarjetas.filter(t => t !== tarjetaActiva);
      if (tarjetas.length === 0) {
        tarjetas = ["Tarjeta 1"];
      }
      tarjetaActiva = tarjetas[0];
      await saveUserData();
      renderTarjetasSelect();
      renderTabla();
    }

    async function a침adirPersona() {
      if (!requireLogin()) return;
      const nombre = prompt("Nombre de la nueva persona:");
      if (!nombre) return;
      const n = nombre.trim();
      if (!n) return;
      if (personas.includes(n)) {
        alert("Esa persona ya existe.");
        return;
      }
      personas.push(n);
      if (!(n in saldos)) {
        saldos[n] = 0;
      }
      personaSeleccionada = n;
      await saveUserData();
      renderPersonasSelect();
    }

    async function eliminarPersona() {
      if (!requireLogin()) return;
      if (!personaSeleccionada) return;
      if (personas.length <= 1) {
        alert("Debe quedar al menos una persona en la lista.");
        return;
      }
      const msg = `Se eliminar치 la persona "${personaSeleccionada}" de la lista.\nLos 칤tems existentes seguir치n mostrando ese nombre.\n쯈uieres continuar?`;
      if (!confirm(msg)) return;

      // Eliminamos de la lista de personas
      personas = personas.filter(p => p !== personaSeleccionada);
      // Eliminamos tambi칠n su saldo
      delete saldos[personaSeleccionada];

      if (personas.length === 0) {
        personas = ["Persona 1"];
        if (!saldos["Persona 1"]) saldos["Persona 1"] = 0;
      }
      personaSeleccionada = personas[0];
      await saveUserData();
      renderPersonasSelect();
    }

    function exportarBackup() {
      if (!requireLogin()) return;
      const data = {
        version: 4,
        uid: currentUser.uid,
        email: currentUser.email,
        items,
        tarjetas,
        personas,
        tarjetaActiva,
        saldos
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json"
      });
      const url = URL.createObjectURL(blob);
      const a   = document.createElement("a");
      const hoy = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = "cuotas-backup-" + hoy + ".json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importarBackupDesdeArchivo(file) {
      if (!requireLogin()) return;

      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const text = e.target.result;

          let data;
          try {
            data = JSON.parse(text);
          } catch (parseError) {
            console.error("Error parseando JSON:", parseError);
            alert("El archivo no es un JSON v치lido.");
            return;
          }

          let importedItems        = [];
          let importedTarjetas     = [];
          let importedPersonas     = [];
          let importedTarjetaActiva = "";
          let importedSaldos       = {};

          if (Array.isArray(data)) {
            importedItems = data;
            importedTarjetas = ["Tarjeta 1"];
            importedPersonas = ["Persona 1"];
          } else if (data && Array.isArray(data.items)) {
            importedItems    = data.items;
            importedTarjetas = Array.isArray(data.tarjetas) ? data.tarjetas : ["Tarjeta 1"];
            importedPersonas = Array.isArray(data.personas) ? data.personas : ["Persona 1"];
            importedTarjetaActiva = data.tarjetaActiva || "";
            if (data.saldos && typeof data.saldos === "object") {
              importedSaldos = data.saldos;
            }
          } else {
            console.error("Estructura de backup no reconocida:", data);
            alert("Archivo de backup inv치lido o con estructura desconocida.");
            return;
          }

          if (!confirm("Esto reemplazar치 todas las tarjetas, personas, saldos e 칤tems actuales de ESTA cuenta. 쮺ontinuar?")) {
            return;
          }

          items = importedItems.map(it => {
            const obj = {
              persona: it.persona || "Persona 1",
              tarjeta: it.tarjeta || (importedTarjetas[0] || "Tarjeta 1"),
              item:    it.item    || "-",
              monto:   Number(it.monto) || 0,
              pagadas: Number(it.pagadas) || 0,
              totales: Number(it.totales) || 1,
              completedAt: typeof it.completedAt === "number" ? it.completedAt : null
            };
            if (obj.totales <= 0) obj.totales = 1;
            if (obj.pagadas < 0) obj.pagadas = 0;
            if (obj.pagadas > obj.totales) obj.pagadas = obj.totales;
            obj.factor = calcularFactor(obj.pagadas, obj.totales);
            obj.total  = obj.monto * obj.factor;
            return obj;
          });

          tarjetas = importedTarjetas && importedTarjetas.length ? importedTarjetas : ["Tarjeta 1"];
          personas = importedPersonas && importedPersonas.length ? importedPersonas : ["Persona 1"];

          tarjetaActiva = importedTarjetaActiva && tarjetas.includes(importedTarjetaActiva)
            ? importedTarjetaActiva
            : tarjetas[0];

          saldos = importedSaldos && typeof importedSaldos === "object" ? importedSaldos : {};

          await saveUserData();
          renderTarjetasSelect();
          renderPersonasSelect();
          renderTabla();

          alert("Backup importado correctamente.");
        } catch (err) {
          console.error("Error general importando backup:", err);
          alert("Error leyendo el archivo de backup.");
        }
      };

      reader.readAsText(file);
    }

    // Eventos de UI
    document.getElementById("addBtn").addEventListener("click", agregarItemDesdeFormulario);
    document.getElementById("clearBtn").addEventListener("click", limpiarTodo);
    document.getElementById("addTarjetaBtn").addEventListener("click", a침adirTarjeta);
    document.getElementById("delTarjetaBtn").addEventListener("click", eliminarTarjeta);
    document.getElementById("addPersonaBtn").addEventListener("click", a침adirPersona);
    document.getElementById("delPersonaBtn").addEventListener("click", eliminarPersona);
    document.getElementById("addSaldoBtn").addEventListener("click", agregarSaldoPersona);
    document.getElementById("exportBtn").addEventListener("click", exportarBackup);
    document.getElementById("importBtn").addEventListener("click", () => {
      document.getElementById("importFile").value = "";
      document.getElementById("importFile").click();
    });
    document.getElementById("importFile").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) importarBackupDesdeArchivo(file);
    });
    document.getElementById("monto").addEventListener("keypress", e => {
      if (e.key === "Enter") agregarItemDesdeFormulario();
    });
    document.getElementById("cuotasTotales").addEventListener("keypress", e => {
      if (e.key === "Enter") agregarItemDesdeFormulario();
    });
    document.getElementById("tarjetaActiva").addEventListener("change", async e => {
      tarjetaActiva = e.target.value;
      await saveUserData();
      renderTabla();
    });
    document.getElementById("personaSelect").addEventListener("change", e => {
      personaSeleccionada = e.target.value;
      updateSaldoUI();
    });
    filtroInput.addEventListener("input", renderTabla);

    // Login / Logout
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error(err);
        alert("Error al iniciar sesi칩n.");
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error(err);
      }
    });

    // Escuchar cambios de auth
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        contenido.classList.remove("hidden");
        loginTexto.textContent = "Sesi칩n iniciada.";
        loginInfo.textContent = "Sesi칩n iniciada como " + (user.email || "");
        await loadUserData();
      } else {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        contenido.classList.add("hidden");
        loginTexto.textContent = "Inicia sesi칩n con Google para usar la app.";
        loginInfo.textContent = "";
      }
    });
  </script>
</body>
</html>
