<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control de cuotas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #000000;
      color: #e5e7eb;
      margin: 0;
      padding: 16px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 12px;
      text-align: center;
    }
    .card {
      max-width: 1100px;
      margin: 0 auto;
      background: #000000;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.8);
      border: 1px solid #27272a;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .top-bar-left,
    .top-bar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px,1fr));
      gap: 8px;
      margin-bottom: 12px;
    }
    label {
      font-size: 12px;
      color: #9ca3af;
      display: block;
      margin-bottom: 2px;
    }
    input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #22c55e55;
    }
    button {
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
      background: #22c55e;
      color: #0b1120;
      font-weight: 600;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.1s;
      white-space: nowrap;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(34,197,94,0.35);
      background: #16a34a;
    }
    button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .danger-btn {
      background: #ef4444;
      color: #fee2e2;
    }
    .danger-btn:hover {
      background: #dc2626;
      box-shadow: 0 8px 16px rgba(248,113,113,0.35);
    }
    .warning-btn {
      background: #facc15;
      color: #1a1a1a;
    }
    .warning-btn:hover {
      background: #eab308;
      box-shadow: 0 8px 16px rgba(250,204,21,0.35);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #27272a;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(even) td { background: #050505; }
    tbody tr:nth-child(odd)  td { background: #000000; }
    .right { text-align: right; }
    .actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .summary {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
      gap: 12px;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #1d4ed8;
      font-size: 11px;
    }
    .totals-card {
      border-radius: 10px;
      border: 1px solid #27272a;
      padding: 10px;
      background: #020617;
      font-size: 13px;
    }
    .totals-card h2 {
      margin: 0 0 6px;
      font-size: 14px;
    }
    .person-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }
    .inline-group {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .hidden { display: none !important; }

    #login-box {
      text-align: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #27272a;
    }
    #login-box p {
      margin-bottom: 8px;
      color: #e5e7eb;
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      margin-top: 4px;
    }
    .filter-bar input {
      max-width: 220px;
    }

    @media (max-width: 700px) {
      .summary {
        grid-template-columns: 1fr;
      }
      table {
        font-size: 12px;
      }
      th, td {
        padding: 4px 6px;
      }
      .actions {
        flex-direction: column;
      }
      .top-bar {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Control de cuotas 游눱</h1>

    <!-- LOGIN CON FIREBASE GOOGLE -->
    <div id="login-box">
      <p id="login-texto">Inicia sesi칩n con Google para usar la app.</p>
      <button id="loginBtn">Iniciar sesi칩n con Google</button>
      <button id="logoutBtn" class="warning-btn hidden">Cerrar sesi칩n</button>
      <p id="login-info" style="font-size:12px;color:#9ca3af;margin-top:6px;"></p>
    </div>

    <!-- CONTENIDO DE LA APP (se oculta hasta que haya login) -->
    <div id="contenido" class="hidden">
      <div class="top-bar">
        <div class="top-bar-left">
          <span>Tarjeta activa:</span>
          <select id="tarjetaActiva"></select>
          <button id="addTarjetaBtn">A침adir tarjeta</button>
          <button id="delTarjetaBtn" class="danger-btn">Eliminar tarjeta</button>
        </div>
        <div class="top-bar-right">
          <button id="exportBtn">Exportar backup</button>
          <button id="importBtn">Importar backup</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>

      <div style="margin-bottom:8px;color:#9ca3af;font-size:12px;">
        Cada 칤tem nuevo se guarda en la tarjeta activa. Tus datos se sincronizan en la nube (Firebase) por cuenta de Google.
      </div>

      <div class="form-grid">
        <div>
          <label>Persona</label>
          <div class="inline-group">
            <select id="personaSelect"></select>
            <button id="addPersonaBtn">+ persona</button>
            <button id="delPersonaBtn" class="danger-btn">- persona</button>
          </div>
        </div>
        <div>
          <label>칈tem</label>
          <input id="item" placeholder="Ej: Producto X" />
        </div>
        <div>
          <label>Monto base (valor de la cuota)</label>
          <input id="monto" type="number" min="0" step="1" placeholder="Ej: 10000" />
        </div>
        <div>
          <label>Cuotas pagadas</label>
          <input id="cuotasPagadas" type="number" min="0" step="1" placeholder="Ej: 3" />
        </div>
        <div>
          <label>Cuotas totales</label>
          <input id="cuotasTotales" type="number" min="1" step="1" placeholder="Ej: 12" />
        </div>
        <div style="display:flex;align-items:flex-end;gap:6px;flex-wrap:wrap;">
          <button id="addBtn">Agregar 칤tem</button>
          <button id="clearBtn" class="danger-btn">Borrar todo</button>
        </div>
      </div>

      <div class="filter-bar">
        <label for="filtro" style="font-size:12px;color:#9ca3af;">Filtro r치pido:</label>
        <input id="filtro" placeholder="Persona, 칤tem o tarjeta..." />
      </div>

      <table>
        <thead>
          <tr>
            <th>Persona</th>
            <th>Tarjeta</th>
            <th>칈tem</th>
            <th class="right">Monto cuota</th>
            <th>Cuotas</th>
            <th class="right">Total contrato</th>
            <th class="right">Pagado</th>
            <th class="right">Pendiente</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-body"></tbody>
      </table>

      <div class="summary">
        <div class="totals-card">
          <h2>Resumen tarjeta activa</h2>
          <div class="person-row">
            <span>Total contrato:</span>
            <span>$<span id="res-total-contrato">0</span></span>
          </div>
          <div class="person-row">
            <span>Total pagado:</span>
            <span>$<span id="res-total-pagado">0</span></span>
          </div>
          <div class="person-row">
            <span>Total pendiente:</span>
            <span>$<span id="res-total-pendiente">0</span></span>
          </div>
          <div class="person-row">
            <span>Cuota mensual estimada:</span>
            <span>$<span id="res-cuota-mensual">0</span></span>
          </div>
          <small class="badge">Basado en una cuota por mes por 칤tem pendiente</small>
        </div>

        <div class="totals-card">
          <h2>Pendiente por persona</h2>
          <div id="totales-persona"></div>
        </div>

        <div class="totals-card">
          <h2>Pendiente por tarjeta</h2>
          <div id="totales-tarjeta"></div>
        </div>

        <div class="totals-card">
          <h2>Cuota mensual por persona<br><small>(tarjeta activa)</small></h2>
          <div id="totales-mensual-persona"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS: Firebase + l칩gica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // 1) PON AQU칈 TU CONFIG DE FIREBASE
    const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_PROJECT_ID.firebaseapp.com",
  projectId: "TU_PROJECT_ID",
  storageBucket: "TU_PROJECT_ID.appspot.com",
  messagingSenderId: "TU_SENDER_ID",
  appId: "TU_APP_ID"
};


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    // Estado
    let items = [];
    let tarjetas = [];
    let personas = [];
    let tarjetaActiva = "";
    let personaSeleccionada = "";
    let currentUser = null; // user de Firebase

    // Helpers UI
    const contenido   = document.getElementById("contenido");
    const loginTexto  = document.getElementById("login-texto");
    const loginInfo   = document.getElementById("login-info");
    const loginBtn    = document.getElementById("loginBtn");
    const logoutBtn   = document.getElementById("logoutBtn");
    const tablaBody   = document.getElementById("tabla-body");
    const filtroInput = document.getElementById("filtro");

    function formatCLP(num) {
      return num.toLocaleString("es-CL");
    }

    function calcularFactor(pagadas, totales) {
      const p = Number(pagadas) || 0;
      const t = Number(totales) || 0;
      if (t <= 0) return 0;
      const f = t - p;
      return f > 0 ? f : 0;
    }

    async function saveUserData() {
      if (!currentUser) return;
      const uid = currentUser.uid;

      const cleanedItems = items.map(it => ({
        persona: it.persona,
        tarjeta: it.tarjeta,
        item:    it.item,
        monto:   it.monto,
        pagadas: it.pagadas,
        totales: it.totales
      }));

      await setDoc(
        doc(db, "users", uid),
        {
          items: cleanedItems,
          tarjetas,
          personas,
          tarjetaActiva
        },
        { merge: true }
      );
    }

    async function loadUserData() {
      if (!currentUser) return;
      const uid = currentUser.uid;

      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        items        = data.items        || [];
        tarjetas     = data.tarjetas     || [];
        personas     = data.personas     || [];
        tarjetaActiva = data.tarjetaActiva || (tarjetas[0] || "");
      } else {
        // Primer uso para este usuario
        items    = [];
        tarjetas = ["Tarjeta 1", "Tarjeta 2"];
        personas = ["Persona 1", "Persona 2"];
        tarjetaActiva = tarjetas[0];
        await saveUserData();
      }

      // Normalizar items
      items.forEach(it => {
        if (it.pagadas === undefined) it.pagadas = 0;
        if (it.totales === undefined || it.totales <= 0) it.totales = 1;
        if (it.monto === undefined) it.monto = 0;
        it.factor = calcularFactor(it.pagadas, it.totales);
        it.total  = it.monto * it.factor;
      });

      if (!Array.isArray(tarjetas) || tarjetas.length === 0) {
        tarjetas = ["Tarjeta 1", "Tarjeta 2"];
      }
      if (!tarjetaActiva || !tarjetas.includes(tarjetaActiva)) {
        tarjetaActiva = tarjetas[0];
      }
      if (!Array.isArray(personas) || personas.length === 0) {
        personas = ["Persona 1", "Persona 2"];
      }
      personaSeleccionada = personas[0];

      renderTarjetasSelect();
      renderPersonasSelect();
      renderTabla();
    }

    function requireLogin() {
      if (!currentUser) {
        alert("Primero inicia sesi칩n con Google.");
        return false;
      }
      return true;
    }

    // Selects
    function renderTarjetasSelect() {
      const select = document.getElementById("tarjetaActiva");
      select.innerHTML = "";
      tarjetas.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        if (t === tarjetaActiva) opt.selected = true;
        select.appendChild(opt);
      });
    }

    function renderPersonasSelect() {
      const select = document.getElementById("personaSelect");
      select.innerHTML = "";
      personas.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      });
      if (personas.includes(personaSeleccionada)) {
        select.value = personaSeleccionada;
      } else {
        personaSeleccionada = personas[0];
        select.value = personaSeleccionada;
      }
    }

    // Tabla + resumen
    function getFilteredItems() {
      const filtro = filtroInput.value.toLowerCase().trim();
      let activos = items.filter(it => it.tarjeta === tarjetaActiva);
      if (filtro) {
        activos = activos.filter(it => {
          const txt = (it.persona + " " + it.item + " " + it.tarjeta).toLowerCase();
          return txt.includes(filtro);
        });
      }
      return activos;
    }

    function renderTabla() {
      tablaBody.innerHTML = "";
      const activos = getFilteredItems();

      let totalContratoTarjeta  = 0;
      let totalPagadoTarjeta    = 0;
      let totalPendienteTarjeta = 0;
      let cuotaMensualGlobal    = 0;

      const porPersonaPendiente = {};
      const porTarjetaPendiente = {};
      const mensualPorPersona   = {};

      activos.forEach(it => {
        const idx = items.indexOf(it);
        const tr  = document.createElement("tr");

        const totalContrato = it.monto * it.totales;
        const pagado        = it.monto * it.pagadas;
        const pendiente     = it.total;

        totalContratoTarjeta  += totalContrato;
        totalPagadoTarjeta    += pagado;
        totalPendienteTarjeta += pendiente;

        if (it.pagadas < it.totales) {
          cuotaMensualGlobal += it.monto;
          mensualPorPersona[it.persona] = (mensualPorPersona[it.persona] || 0) + it.monto;
        }

        porPersonaPendiente[it.persona] = (porPersonaPendiente[it.persona] || 0) + pendiente;

        const tdPersona = document.createElement("td");
        tdPersona.textContent = it.persona;
        tr.appendChild(tdPersona);

        const tdTarjeta = document.createElement("td");
        tdTarjeta.textContent = it.tarjeta || "-";
        tr.appendChild(tdTarjeta);

        const tdItem = document.createElement("td");
        tdItem.textContent = it.item;
        tr.appendChild(tdItem);

        const tdMonto = document.createElement("td");
        tdMonto.className = "right";
        tdMonto.textContent = "$" + formatCLP(it.monto);
        tr.appendChild(tdMonto);

        const tdCuotas = document.createElement("td");
        tdCuotas.textContent = `${it.pagadas}/${it.totales}`;
        tr.appendChild(tdCuotas);

        const tdTotalContrato = document.createElement("td");
        tdTotalContrato.className = "right";
        tdTotalContrato.textContent = "$" + formatCLP(totalContrato);
        tr.appendChild(tdTotalContrato);

        const tdPagado = document.createElement("td");
        tdPagado.className = "right";
        tdPagado.textContent = "$" + formatCLP(pagado);
        tr.appendChild(tdPagado);

        const tdPendiente = document.createElement("td");
        tdPendiente.className = "right";
        tdPendiente.textContent = "$" + formatCLP(pendiente);
        tr.appendChild(tdPendiente);

        const tdAcciones = document.createElement("td");
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "actions";

        const pagarBtn = document.createElement("button");
        pagarBtn.textContent = "Pagar cuota";
        pagarBtn.addEventListener("click", async () => {
          if (!requireLogin()) return;
          await pagarCuota(idx);
        });

        const deshacerBtn = document.createElement("button");
        deshacerBtn.textContent = "Deshacer cuota";
        deshacerBtn.className = "warning-btn";
        deshacerBtn.addEventListener("click", async () => {
          if (!requireLogin()) return;
          await deshacerCuota(idx);
        });

        const borrarBtn = document.createElement("button");
        borrarBtn.textContent = "Borrar";
        borrarBtn.className = "danger-btn";
        borrarBtn.addEventListener("click", async () => {
          if (!requireLogin()) return;
          await borrarFila(idx);
        });

        if (it.pagadas >= it.totales) {
          pagarBtn.disabled = true;
          pagarBtn.style.opacity = 0.5;
          pagarBtn.style.cursor = "default";
        }
        if (it.pagadas <= 0) {
          deshacerBtn.disabled = true;
          deshacerBtn.style.opacity = 0.5;
          deshacerBtn.style.cursor = "default";
        }

        actionsDiv.appendChild(pagarBtn);
        actionsDiv.appendChild(deshacerBtn);
        actionsDiv.appendChild(borrarBtn);
        tdAcciones.appendChild(actionsDiv);
        tr.appendChild(tdAcciones);

        tablaBody.appendChild(tr);
      });

      // Resumen tarjeta activa
      document.getElementById("res-total-contrato").textContent  = formatCLP(totalContratoTarjeta);
      document.getElementById("res-total-pagado").textContent    = formatCLP(totalPagadoTarjeta);
      document.getElementById("res-total-pendiente").textContent = formatCLP(totalPendienteTarjeta);
      document.getElementById("res-cuota-mensual").textContent   = formatCLP(cuotaMensualGlobal);

      // Pendiente por persona
      const contPers = document.getElementById("totales-persona");
      contPers.innerHTML = "";
      const personasTot = Object.entries(porPersonaPendiente);
      if (personasTot.length === 0) {
        contPers.textContent = "Sin datos todav칤a.";
      } else {
        personasTot.forEach(([persona, total]) => {
          const row = document.createElement("div");
          row.className = "person-row";
          row.innerHTML = `<span>${persona}</span><span>$${formatCLP(total)}</span>`;
          contPers.appendChild(row);
        });
      }

      // Pendiente por tarjeta
      const contTarjeta = document.getElementById("totales-tarjeta");
      contTarjeta.innerHTML = "";
      items.forEach(it => {
        const key = it.tarjeta || "Sin tarjeta";
        porTarjetaPendiente[key] = (porTarjetaPendiente[key] || 0) + it.total;
      });
      const tarjetasTotals = Object.entries(porTarjetaPendiente);
      if (tarjetasTotals.length === 0) {
        contTarjeta.textContent = "Sin datos todav칤a.";
      } else {
        tarjetasTotals.forEach(([tarj, total]) => {
          const row = document.createElement("div");
          row.className = "person-row";
          row.innerHTML = `<span>${tarj}</span><span>$${formatCLP(total)}</span>`;
          contTarjeta.appendChild(row);
        });
      }

      // Cuota mensual por persona (tarjeta activa)
      const contMensualPersona = document.getElementById("totales-mensual-persona");
      contMensualPersona.innerHTML = "";
      const mensualTot = Object.entries(mensualPorPersona);
      if (mensualTot.length === 0) {
        contMensualPersona.textContent = "Sin cuotas pendientes en esta tarjeta.";
      } else {
        mensualTot.forEach(([persona, total]) => {
          const row = document.createElement("div");
          row.className = "person-row";
          row.innerHTML = `<span>${persona}</span><span>$${formatCLP(total)}</span>`;
          contMensualPersona.appendChild(row);
        });
      }
    }

    // Acciones
    async function agregarItemDesdeFormulario() {
      if (!requireLogin()) return;

      const personaSel   = document.getElementById("personaSelect");
      const itemInput    = document.getElementById("item");
      const montoInput   = document.getElementById("monto");
      const pagadasInput = document.getElementById("cuotasPagadas");
      const totalesInput = document.getElementById("cuotasTotales");

      const persona = personaSel.value || personas[0];
      const item    = itemInput.value.trim() || "-";
      const monto   = parseInt(montoInput.value, 10);
      const pagadas = parseInt(pagadasInput.value, 10) || 0;
      const totales = parseInt(totalesInput.value, 10) || 0;

      if (isNaN(monto) || monto <= 0) {
        alert("Pon un monto v치lido (mayor que 0).");
        return;
      }
      if (totales <= 0) {
        alert("Pon un n칰mero de cuotas totales mayor que 0.");
        return;
      }
      if (pagadas < 0 || pagadas > totales) {
        alert("Las cuotas pagadas deben estar entre 0 y el total.");
        return;
      }
      if (!tarjetaActiva) {
        alert("Primero crea o selecciona una tarjeta.");
        return;
      }

      const nuevo = {
        persona,
        tarjeta: tarjetaActiva,
        item,
        monto,
        pagadas,
        totales,
        factor: 0,
        total: 0
      };
      nuevo.factor = calcularFactor(nuevo.pagadas, nuevo.totales);
      nuevo.total  = nuevo.monto * nuevo.factor;

      items.push(nuevo);
      await saveUserData();
      renderTabla();

      itemInput.value    = "";
      montoInput.value   = "";
      pagadasInput.value = "";
      totalesInput.value = "";
      itemInput.focus();
    }

    async function pagarCuota(idx) {
      const it = items[idx];
      if (it.pagadas >= it.totales) return;
      it.pagadas += 1;
      it.factor   = calcularFactor(it.pagadas, it.totales);
      it.total    = it.monto * it.factor;
      await saveUserData();
      renderTabla();
    }

    async function deshacerCuota(idx) {
      const it = items[idx];
      if (it.pagadas <= 0) return;
      it.pagadas -= 1;
      it.factor   = calcularFactor(it.pagadas, it.totales);
      it.total    = it.monto * it.factor;
      await saveUserData();
      renderTabla();
    }

    async function borrarFila(idx) {
      if (!confirm("쮹orrar este 칤tem?")) return;
      items.splice(idx, 1);
      await saveUserData();
      renderTabla();
    }

    async function limpiarTodo() {
      if (!requireLogin()) return;
      if (!confirm("쯉eguro que quieres borrar TODOS los 칤tems de esta cuenta?")) return;
      items = [];
      await saveUserData();
      renderTabla();
    }

    async function a침adirTarjeta() {
      if (!requireLogin()) return;
      const nombre = prompt("Nombre de la nueva tarjeta (ej: Tarjeta 3):");
      if (!nombre) return;
      const n = nombre.trim();
      if (!n) return;
      if (tarjetas.includes(n)) {
        alert("Esa tarjeta ya existe.");
        return;
      }
      tarjetas.push(n);
      tarjetaActiva = n;
      await saveUserData();
      renderTarjetasSelect();
      renderTabla();
    }

    async function eliminarTarjeta() {
      if (!requireLogin()) return;
      if (!tarjetaActiva) return;
      if (tarjetas.length <= 1) {
        alert("Debe quedar al menos una tarjeta.");
        return;
      }
      const asociados = items.filter(it => it.tarjeta === tarjetaActiva).length;
      const msg = `Se eliminar치 la tarjeta "${tarjetaActiva}" y ${asociados} 칤tems asociados.\n쯈uieres continuar?`;
      if (!confirm(msg)) return;

      items    = items.filter(it => it.tarjeta !== tarjetaActiva);
      tarjetas = tarjetas.filter(t => t !== tarjetaActiva);
      if (tarjetas.length === 0) {
        tarjetas = ["Tarjeta 1"];
      }
      tarjetaActiva = tarjetas[0];
      await saveUserData();
      renderTarjetasSelect();
      renderTabla();
    }

    async function a침adirPersona() {
      if (!requireLogin()) return;
      const nombre = prompt("Nombre de la nueva persona:");
      if (!nombre) return;
      const n = nombre.trim();
      if (!n) return;
      if (personas.includes(n)) {
        alert("Esa persona ya existe.");
        return;
      }
      personas.push(n);
      personaSeleccionada = n;
      await saveUserData();
      renderPersonasSelect();
    }

    async function eliminarPersona() {
      if (!requireLogin()) return;
      if (!personaSeleccionada) return;
      if (personas.length <= 1) {
        alert("Debe quedar al menos una persona en la lista.");
        return;
      }
      const msg = `Se eliminar치 la persona "${personaSeleccionada}" de la lista.\nLos 칤tems existentes seguir치n mostrando ese nombre.\n쯈uieres continuar?`;
      if (!confirm(msg)) return;

      personas = personas.filter(p => p !== personaSeleccionada);
      if (personas.length === 0) {
        personas = ["Persona 1"];
      }
      personaSeleccionada = personas[0];
      await saveUserData();
      renderPersonasSelect();
    }

    function exportarBackup() {
      if (!requireLogin()) return;
      const data = {
        version: 3,
        uid: currentUser.uid,
        email: currentUser.email,
        items,
        tarjetas,
        personas,
        tarjetaActiva
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json"
      });
      const url = URL.createObjectURL(blob);
      const a   = document.createElement("a");
      const hoy = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = "cuotas-backup-" + hoy + ".json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importarBackupDesdeArchivo(file) {
      if (!requireLogin()) return;
      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data || !Array.isArray(data.items) || !Array.isArray(data.tarjetas) || !Array.isArray(data.personas)) {
            alert("Archivo de backup inv치lido.");
            return;
          }
          if (!confirm("Esto reemplazar치 todas las tarjetas, personas e 칤tems actuales de ESTA cuenta. 쮺ontinuar?")) {
            return;
          }

          items        = data.items        || [];
          tarjetas     = data.tarjetas     || [];
          personas     = data.personas     || [];
          tarjetaActiva = data.tarjetaActiva || (tarjetas[0] || "");

          items.forEach(it => {
            if (it.pagadas === undefined) it.pagadas = 0;
            if (it.totales === undefined || it.totales <= 0) it.totales = 1;
            if (it.monto === undefined) it.monto = 0;
            it.factor = calcularFactor(it.pagadas, it.totales);
            it.total  = it.monto * it.factor;
          });

          if (!Array.isArray(tarjetas) || tarjetas.length === 0) tarjetas = ["Tarjeta 1"];
          if (!Array.isArray(personas) || personas.length === 0) personas = ["Persona 1"];

          await saveUserData();
          renderTarjetasSelect();
          renderPersonasSelect();
          renderTabla();

          alert("Backup importado correctamente.");
        } catch (err) {
          console.error(err);
          alert("Error leyendo el archivo de backup.");
        }
      };
      reader.readAsText(file);
    }

    // Eventos de UI
    document.getElementById("addBtn").addEventListener("click", agregarItemDesdeFormulario);
    document.getElementById("clearBtn").addEventListener("click", limpiarTodo);
    document.getElementById("addTarjetaBtn").addEventListener("click", a침adirTarjeta);
    document.getElementById("delTarjetaBtn").addEventListener("click", eliminarTarjeta);
    document.getElementById("addPersonaBtn").addEventListener("click", a침adirPersona);
    document.getElementById("delPersonaBtn").addEventListener("click", eliminarPersona);
    document.getElementById("exportBtn").addEventListener("click", exportarBackup);
    document.getElementById("importBtn").addEventListener("click", () => {
      document.getElementById("importFile").value = "";
      document.getElementById("importFile").click();
    });
    document.getElementById("importFile").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) importarBackupDesdeArchivo(file);
    });
    document.getElementById("monto").addEventListener("keypress", e => {
      if (e.key === "Enter") agregarItemDesdeFormulario();
    });
    document.getElementById("cuotasTotales").addEventListener("keypress", e => {
      if (e.key === "Enter") agregarItemDesdeFormulario();
    });
    document.getElementById("tarjetaActiva").addEventListener("change", async e => {
      tarjetaActiva = e.target.value;
      await saveUserData();
      renderTabla();
    });
    document.getElementById("personaSelect").addEventListener("change", e => {
      personaSeleccionada = e.target.value;
    });
    filtroInput.addEventListener("input", renderTabla);

    // Login / Logout
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error(err);
        alert("Error al iniciar sesi칩n.");
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error(err);
      }
    });

    // Escuchar cambios de auth
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        contenido.classList.remove("hidden");
        loginTexto.textContent = "Sesi칩n iniciada.";
        loginInfo.textContent = "Sesi칩n iniciada como " + (user.email || "");
        await loadUserData();
      } else {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        contenido.classList.add("hidden");
        loginTexto.textContent = "Inicia sesi칩n con Google para usar la app.";
        loginInfo.textContent = "";
      }
    });
  </script>
</body>
</html>
